<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½å®³æ•‘åŠ©è¡Œå‹•æŒ‡æ®ç³»çµ± v5.0 - çµ‚æ¥µæ•´åˆç‰ˆ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React, ReactDOM & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* åŸºç¤è¨­å®š */
        :root {
            --primary: #0f172a; /* Slate 900 */
            --accent: #2563eb;  /* Blue 600 */
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #ca8a04;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; }
        
        /* ç»ç’ƒæ“¬æ…‹èˆ‡å‹•ç•« */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .login-pattern {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 0.5px, transparent 0.5px);
            background-size: 24px 24px;
        }
        
        /* åœ°åœ–æ¨¡æ“¬èƒŒæ™¯ */
        .map-bg {
            background-image: url('https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/121.5,24.0,10,0/1200x800?access_token=none');
            background-size: cover;
            background-position: center;
        }
        
        /* SOS æŒ‰éˆ•ç‰¹æ•ˆ */
        .sos-btn {
            background: radial-gradient(circle, #ef4444 0%, #b91c1c 100%);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: sos-pulse 1.5s infinite;
        }
        @keyframes sos-pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Toast å‹•ç•« */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Mock Data ---
        const INITIAL_INCIDENTS = [
            { id: 'inc-1', name: 'èŠ±è“® 0403 åœ°éœ‡å°ˆæ¡ˆ', level: '2ç´š (ç¸£å¸‚)', status: 'åŸ·è¡Œä¸­', date: '2024-04-03', commander: 'æ—å±€é•·' },
            { id: 'inc-2', name: 'å—æŠ•åœŸçŸ³æµé è­¦å°ˆæ¡ˆ', level: '1ç´š (é„‰é®)', status: 'æº–å‚™ä¸­', date: '2024-05-12', commander: 'é™³å€é•·' },
        ];

        const ROLES = [
            { id: 'ic', name: 'æŒ‡æ®å®˜ (IC)', icon: 'shield-check', color: 'bg-red-600', desc: 'å…¨æ¬ŠæŒ‡æ®ã€æ±ºç­–ä¸‹é”' },
            { id: 'ops', name: 'ä½œæ¥­çµ„ (Ops)', icon: 'activity', color: 'bg-blue-600', desc: 'æœæ•‘ã€é†«ç™‚ã€å·¥ç¨‹' },
            { id: 'log', name: 'å¾Œå‹¤çµ„ (Log)', icon: 'package', color: 'bg-orange-500', desc: 'ç‰©è³‡ã€é‹è¼¸ã€é€šè¨Š' },
            { id: 'vol', name: 'å¿—å·¥éšŠ (Vol)', icon: 'users', color: 'bg-slate-600', desc: 'äººåŠ›æ”¯æ´ã€æ°‘çœ¾æœå‹™' },
        ];

        const INITIAL_MY_GEAR = [
            { id: 'g1', name: 'å€‹äººé ­ç‡ˆ (LED)', type: 'è‡ªæ”œ', status: 'æŒæœ‰ä¸­', condition: 'A' },
            { id: 'g2', name: 'å¤šåŠŸèƒ½é‰—', type: 'è‡ªæ”œ', status: 'æŒæœ‰ä¸­', condition: 'B' },
        ];
        
        const INITIAL_BORROWED_GEAR = [
            { id: 'b1', name: 'ç„¡ç·šé›»å°è¬›æ©Ÿ (Motorola)', source: 'å¾Œå‹¤çµ„', borrowedAt: '10:30', status: 'ä½¿ç”¨ä¸­' }
        ];

        const LIFE_SUPPORT_FACILITIES = [
            { id: 'f1', name: 'Aå€ç†±é£Ÿç«™', type: 'food', status: 'ä¾›é¤ä¸­', capacity: 'å‰©é¤˜ 50 ä»½', location: 'é«”è‚²é¤¨å…¥å£' },
            { id: 'f2', name: 'Bå€è¡Œå‹•æ·‹æµ´é–“', type: 'shower', status: 'æ’éšŠä¸­', capacity: 'ç­‰å¾… 15 åˆ†', location: 'æ“å ´åŒ—å´' },
            { id: 'f3', name: 'å¿—å·¥ä¼‘æ¯å¸³ (Cå€)', type: 'sleep', status: 'é¡æ»¿', capacity: '0 åºŠ', location: 'ç¬¬äºŒæ ¡å€' },
            { id: 'f4', name: 'è¡Œå‹•å……é›»ç«™', type: 'power', status: 'å¯ç”¨', capacity: '80%', location: 'æŒ‡æ®æ‰€æ—' },
        ];

        // --- Helper Components ---
        const ToastContainer = ({ toasts, removeToast }) => (
            <div className="fixed bottom-20 right-6 z-50 flex flex-col gap-2 pointer-events-none">
                {toasts.map(toast => (
                    <div key={toast.id} className="toast-enter pointer-events-auto bg-white border border-slate-200 shadow-xl rounded-xl p-4 flex items-center gap-3 min-w-[300px]">
                        <div className={`p-2 rounded-full ${toast.type === 'success' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}`}>
                            <i data-lucide={toast.type === 'success' ? 'check' : 'info'} width="16"></i>
                        </div>
                        <div className="flex-1">
                            <p className="text-sm font-bold text-slate-800">{toast.title}</p>
                            <p className="text-xs text-slate-500">{toast.message}</p>
                        </div>
                        <button onClick={() => removeToast(toast.id)} className="text-slate-400 hover:text-slate-600"><i data-lucide="x" width="14"></i></button>
                    </div>
                ))}
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white border border-slate-200 rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl scale-100 animate-in zoom-in-95 duration-200">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span className="w-1 h-6 bg-blue-600 rounded-full"></span>
                                {title}
                            </h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition-colors text-slate-500">
                                <i data-lucide="x" width="20"></i>
                            </button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const PageHeader = ({ title, icon, color, btnText, onBtnClick }) => (
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2">
                    <i data-lucide={icon} className={color}></i> {title}
                </h2>
                {btnText && (
                    <button onClick={onBtnClick} className="px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-bold shadow-lg flex items-center gap-2 transition-all">
                        <i data-lucide="plus" width="16"></i> {btnText}
                    </button>
                )}
            </div>
        );

        const StatusBadge = ({ status }) => {
            const colors = {
                'é€¾æ™‚': 'bg-red-100 text-red-700 border-red-200',
                'å·²å ±åˆ°': 'bg-green-100 text-green-700 border-green-200',
                'é ç´„ä¸­': 'bg-blue-50 text-blue-600 border-blue-200',
                'å¾…è™•ç†': 'bg-slate-100 text-slate-600 border-slate-200',
                'é‹é€ä¸­': 'bg-blue-100 text-blue-700 border-blue-200',
                'å·²é€é”': 'bg-green-100 text-green-700 border-green-200',
                'ç·Šæ€¥': 'bg-red-600 text-white border-red-600',
            };
            const style = colors[status] || 'bg-slate-100 text-slate-600 border-slate-200';
            return <span className={`px-2.5 py-0.5 rounded-full text-[10px] font-bold border ${style} shadow-sm whitespace-nowrap`}>{status}</span>;
        };

        // --- Views ---

        const LoginView = ({ onLogin }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className="h-screen w-full flex items-center justify-center login-pattern p-4">
                    <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div className="hidden md:block">
                            <div className="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center shadow-lg mb-6">
                                <i data-lucide="shield-check" className="text-white w-10 h-10"></i>
                            </div>
                            <h1 className="text-4xl font-black text-slate-900 mb-4 tracking-tight">ç½å®³æ•‘åŠ©è¡Œå‹•<br/>æŒ‡æ®ç³»çµ± <span className="text-blue-600 font-normal">v5.0</span></h1>
                            <p className="text-slate-500 leading-relaxed max-w-sm mb-8 font-medium">
                                æ•´åˆ ICS æŒ‡æ®é«”ç³»èˆ‡è³‡æå¾ªç’°æ©Ÿåˆ¶ã€‚è«‹é¸æ“‡æ‚¨çš„èº«ä»½é€²å…¥ç³»çµ±ã€‚
                            </p>
                        </div>
                        <div className="bg-white border border-slate-200 p-8 rounded-[2.5rem] shadow-2xl">
                            <h3 className="text-xl font-bold text-slate-800 mb-6">èº«ä»½ç™»å…¥</h3>
                            <div className="space-y-3">
                                {ROLES.map(role => (
                                    <button 
                                        key={role.id}
                                        onClick={() => onLogin(role)}
                                        className="w-full flex items-center gap-4 p-4 rounded-2xl border border-slate-100 bg-slate-50 hover:bg-white hover:border-blue-500 hover:shadow-lg transition-all text-left group"
                                    >
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white ${role.color}`}>
                                            <i data-lucide={role.icon}></i>
                                        </div>
                                        <div className="flex-1">
                                            <p className="font-bold text-slate-800 group-hover:text-blue-600">{role.name}</p>
                                            <p className="text-[10px] text-slate-400 font-medium">{role.desc}</p>
                                        </div>
                                        <i data-lucide="chevron-right" className="text-slate-300 opacity-0 group-hover:opacity-100 transition-all"></i>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const VolunteersView = ({ data, onAdd, onUpdate, onDelete }) => (
            <div className="max-w-6xl mx-auto animate-in fade-in">
                <PageHeader title="å¿—å·¥äººåŠ›ç®¡ç†" icon="users" color="text-blue-600" btnText="ç™»éŒ„å¿—å·¥" onBtnClick={onAdd} />
                <div className="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs border-b border-slate-200">
                            <tr>
                                <th className="px-6 py-4">å§“å / è¯çµ¡</th>
                                <th className="px-6 py-4">æŠ€èƒ½æ¨™ç±¤</th>
                                <th className="px-6 py-4">é è¨ˆå ±åˆ°</th>
                                <th className="px-6 py-4">ç‹€æ…‹</th>
                                <th className="px-6 py-4 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {data.map(res => (
                                <tr key={res.id} className="hover:bg-slate-50 transition-colors group">
                                    <td className="px-6 py-4">
                                        <div className="font-bold text-slate-800">{res.name}</div>
                                        <div className="text-xs text-slate-400 font-mono">{res.phone}</div>
                                    </td>
                                    <td className="px-6 py-4"><span className="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs border border-slate-200">{res.skill}</span></td>
                                    <td className="px-6 py-4 text-slate-500 font-mono text-xs">{new Date(res.time).toLocaleString()}</td>
                                    <td className="px-6 py-4"><StatusBadge status={res.status} /></td>
                                    <td className="px-6 py-4 text-right">
                                        <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            {res.status !== 'å·²å ±åˆ°' && (
                                                <button onClick={() => onUpdate(res.id, 'å·²å ±åˆ°')} className="px-2 py-1 bg-green-50 text-green-600 rounded border border-green-200 text-xs font-bold hover:bg-green-100">ç°½åˆ°</button>
                                            )}
                                            <button onClick={() => onDelete(res.id)} className="p-1 text-slate-400 hover:text-red-500"><i data-lucide="trash-2" width="16"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {data.length === 0 && <div className="p-8 text-center text-slate-400 italic">æŸ¥ç„¡è³‡æ–™</div>}
                </div>
            </div>
        );

        const LogisticsView = ({ data, onAdd, onUpdate }) => (
            <div className="max-w-6xl mx-auto animate-in fade-in">
                <PageHeader title="å¾Œå‹¤è³‡æºèª¿åº¦" icon="package" color="text-orange-500" btnText="æäº¤éœ€æ±‚" onBtnClick={onAdd} />
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    {data.map(req => (
                        <div key={req.id} className="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group">
                            <div className={`absolute left-0 top-0 bottom-0 w-1 ${req.priority === 'ç·Šæ€¥' ? 'bg-red-500' : 'bg-slate-300'}`}></div>
                            <div className="flex justify-between items-start mb-3 pl-2">
                                <h4 className="font-bold text-slate-800 text-lg">{req.item}</h4>
                                <StatusBadge status={req.priority} />
                            </div>
                            <div className="pl-2 space-y-2 text-sm text-slate-500">
                                <div className="flex justify-between">
                                    <span>æ•¸é‡: <strong className="text-slate-800">{req.qty}</strong></span>
                                    <span>ä¾†è‡ª: {req.from}</span>
                                </div>
                                <div className="flex justify-between items-center pt-3 border-t border-slate-100">
                                    <span className="text-xs font-bold text-blue-600">{req.status}</span>
                                    <div className="flex gap-2">
                                        {req.status === 'å¾…è™•ç†' && <button onClick={() => onUpdate(req.id, 'é‹é€ä¸­')} className="px-3 py-1 bg-blue-600 text-white rounded text-xs font-bold hover:bg-blue-700">æ ¸å‡†</button>}
                                        {req.status === 'é‹é€ä¸­' && <button onClick={() => onUpdate(req.id, 'å·²é€é”')} className="px-3 py-1 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700">ç°½æ”¶</button>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                    {data.length === 0 && <div className="col-span-full p-8 text-center text-slate-400 italic">æŸ¥ç„¡éœ€æ±‚å–®</div>}
                </div>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [activeIncidentId, setActiveIncidentId] = useState('inc-1');
            const [incidents, setIncidents] = useState(INITIAL_INCIDENTS);
            const [isSOSModalOpen, setIsSOSModalOpen] = useState(false);
            const [mapLayers, setMapLayers] = useState({ hazard: true, resources: true, volunteers: true });
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalType, setModalType] = useState(null);
            const [toasts, setToasts] = useState([]);

            // Data States
            const [reservations, setReservations] = useState([
                { id: 1, name: 'ç‹å°æ˜', phone: '0912-345-678', skill: 'USAR æœç´¢', time: new Date().toISOString(), status: 'é€¾æ™‚' },
                { id: 2, name: 'é™³ç¾éº—', phone: '0922-111-222', skill: 'è­·ç†å¸«', time: new Date().toISOString(), status: 'é ç´„ä¸­' },
            ]);
            const [requests, setRequests] = useState([
                { id: 1, item: 'ç™¼é›»æ©Ÿ 5KW', qty: 2, from: 'å‰é€²æŒ‡æ®æ‰€', status: 'å¾…è™•ç†', priority: 'ç·Šæ€¥' },
            ]);
            const [myGear, setMyGear] = useState(INITIAL_MY_GEAR);
            const [borrowedGear, setBorrowedGear] = useState(INITIAL_BORROWED_GEAR);

            useEffect(() => { lucide.createIcons(); }, [currentUser, activeTab, isModalOpen, reservations, requests, myGear]);

            const addToast = (title, message, type = 'success') => {
                const id = Date.now();
                setToasts([...toasts, { id, title, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };

            const handleLogout = () => { setCurrentUser(null); setActiveTab('dashboard'); };

            const activeIncident = incidents.find(i => i.id === activeIncidentId);

            // Handlers
            const handleVolunteerAdd = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                setReservations([...reservations, { 
                    id: Date.now(), name: fd.get('name'), phone: fd.get('phone'), skill: fd.get('skill'), time: new Date().toISOString(), status: 'é ç´„ä¸­' 
                }]);
                addToast('æˆåŠŸ', 'å·²æ–°å¢å¿—å·¥è³‡æ–™');
                setIsModalOpen(false);
            };

            const handleLogisticsAdd = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                setRequests([...requests, {
                    id: Date.now(), item: fd.get('item'), qty: fd.get('qty'), from: fd.get('from'), status: 'å¾…è™•ç†', priority: fd.get('priority')
                }]);
                addToast('æˆåŠŸ', 'éœ€æ±‚å–®å·²æäº¤');
                setIsModalOpen(false);
            };

            const handleGearReturn = (id, isDonating) => {
                if (confirm(isDonating ? "ç¢ºèªæ­¸é‚„ä¸¦æè´ˆæ­¤ç‰©è³‡ï¼Ÿ" : "ç¢ºèªæ­¸é‚„ç‰©è³‡ï¼Ÿ")) {
                    setBorrowedGear(prev => prev.filter(g => g.id !== id));
                    addToast('è™•ç†å®Œæˆ', isDonating ? "ç‰©è³‡å·²è½‰ç‚ºæè´ˆå…¥åº«" : "ç‰©è³‡å·²æ­¸é‚„");
                }
            };

            const renderContent = () => {
                switch(activeTab) {
                    case 'dashboard':
                        return (
                            <div className="p-6 max-w-6xl mx-auto animate-in fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <div><h2 className="text-2xl font-black text-slate-800">æŒ‡æ®ç¸½è¦½</h2><p className="text-sm text-slate-500">èŠ±è“® 0403 éœ‡ç½å°ˆæ¡ˆ (äºŒç´šé–‹è¨­)</p></div>
                                    <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">é€£ç·šç©©å®š</span>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                    {[
                                        { label: 'å‰ç·šäººåŠ›', val: reservations.length + 120, unit: 'äºº', icon: 'users', color: 'bg-blue-100 text-blue-600' },
                                        { label: 'å¾…è™•ç†éœ€æ±‚', val: requests.filter(r=>r.status==='å¾…è™•ç†').length, unit: 'ä»¶', icon: 'package', color: 'bg-orange-100 text-orange-600' },
                                        { label: 'è³‡æå¾ªç’°ç‡', val: '89', unit: '%', icon: 'recycle', color: 'bg-green-100 text-green-600' },
                                        { label: 'é¿é›£è² è·', val: '82', unit: '%', icon: 'home', color: 'bg-red-100 text-red-600' },
                                    ].map((stat, idx) => (
                                        <div key={idx} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4">
                                            <div className={`p-3 rounded-xl ${stat.color}`}><i data-lucide={stat.icon}></i></div>
                                            <div><p className="text-xs text-slate-500 font-bold uppercase">{stat.label}</p><p className="text-2xl font-black text-slate-800">{stat.val} <span className="text-xs text-slate-400 font-normal">{stat.unit}</span></p></div>
                                        </div>
                                    ))}
                                </div>
                                {/* å…¬å‘Šå€ */}
                                <div className="bg-slate-900 text-white rounded-2xl p-6 relative overflow-hidden">
                                    <div className="relative z-10">
                                        <h3 className="text-lg font-bold flex items-center gap-2 mb-4"><i data-lucide="bell" className="text-yellow-400"></i> æŒ‡æ®ä¸­å¿ƒå…¬å‘Š (CAP Alert)</h3>
                                        <div className="space-y-3">
                                            <div className="bg-white/10 p-3 rounded-xl border border-white/10 flex gap-3">
                                                <span className="text-yellow-400 font-mono text-xs pt-1">10:45</span>
                                                <div><p className="text-sm font-bold">é¤˜éœ‡è­¦å ± (ç´šåˆ¥: é»ƒè‰²)</p><p className="text-xs text-slate-300">é æ¸¬æœªä¾† 2 å°æ™‚å…§å¯èƒ½æœ‰è¦æ¨¡ 4.0 ä»¥ä¸Šé¤˜éœ‡ã€‚</p></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'map':
                        return (
                            <div className="h-full relative bg-slate-200 w-full">
                                <div className="absolute inset-0 map-bg opacity-80"></div>
                                <div className="absolute top-4 right-4 bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg border border-slate-200 flex flex-col gap-2 z-10 w-40">
                                    <span className="text-[10px] font-bold text-slate-400 uppercase mb-1">GIS åœ–å±¤æ§åˆ¶</span>
                                    {Object.keys(mapLayers).map(key => (
                                        <button key={key} onClick={() => setMapLayers({...mapLayers, [key]: !mapLayers[key]})} className={`flex items-center justify-between px-3 py-2 rounded-lg text-xs font-bold transition-all ${mapLayers[key] ? 'bg-blue-50 text-blue-600 border border-blue-200' : 'bg-slate-50 text-slate-400 border border-slate-100'}`}>
                                            <span>{key === 'hazard' ? 'ğŸ”´ å±éšªç†±å€' : key === 'resources' ? 'ğŸ”µ è³‡æºåˆ†ä½ˆ' : 'ğŸŸ¢ å¿—å·¥å®šä½'}</span>
                                            {mapLayers[key] && <i data-lucide="check" width="12"></i>}
                                        </button>
                                    ))}
                                </div>
                                {/* åœ°åœ–æ¨™è¨˜æ¨¡æ“¬ */}
                                {mapLayers.hazard && <div className="absolute top-1/3 left-1/4 animate-pulse"><div className="w-16 h-16 bg-red-500/30 rounded-full flex items-center justify-center border border-red-500"><i data-lucide="alert-triangle" className="text-red-600"></i></div><span className="absolute -bottom-6 left-2 bg-black text-white text-[10px] px-2 py-1 rounded">è½çŸ³å€</span></div>}
                            </div>
                        );
                    case 'volunteers':
                        return <VolunteersView data={reservations} onAdd={() => { setModalType('volunteer'); setIsModalOpen(true); }} onUpdate={(id, status) => { setReservations(prev => prev.map(i => i.id === id ? { ...i, status } : i)); addToast('ç°½åˆ°æˆåŠŸ', 'ç‹€æ…‹å·²æ›´æ–°'); }} onDelete={(id) => { if(confirm('åˆªé™¤?')) setReservations(prev => prev.filter(i => i.id !== id)); }} />;
                    case 'logistics':
                        return <LogisticsView data={requests} onAdd={() => { setModalType('logistics'); setIsModalOpen(true); }} onUpdate={(id, status) => { setRequests(prev => prev.map(i => i.id === id ? { ...i, status } : i)); addToast('å¯©æ ¸å®Œæˆ', `ç‹€æ…‹æ›´æ–°ç‚º: ${status}`); }} />;
                    case 'resource':
                        return (
                            <div className="p-6 max-w-4xl mx-auto animate-in fade-in">
                                <PageHeader title="è³‡æå¾ªç’°ç³»çµ±" icon="recycle" color="text-green-600" btnText="æƒç¢¼å€Ÿç”¨/æ­¸é‚„" onBtnClick={() => alert('é–‹å•Ÿç›¸æ©Ÿæƒç¢¼...')} />
                                <div className="mb-8"><h3 className="text-sm font-bold text-slate-500 uppercase tracking-widest mb-3">å€Ÿç”¨ä¸­è³‡æ (Borrowed)</h3><div className="grid gap-4">{borrowedGear.map(item => (<div key={item.id} className="bg-white p-4 rounded-xl border border-blue-200 shadow-sm flex justify-between items-center relative overflow-hidden"><div className="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div><div><p className="font-bold text-slate-800">{item.name}</p><p className="text-xs text-slate-500">ä¾†æº: {item.source}</p></div><div className="flex gap-2"><button onClick={() => handleGearReturn(item.id, false)} className="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">æ­¸é‚„</button><button onClick={() => handleGearReturn(item.id, true)} className="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-xs font-bold hover:bg-green-200 border border-green-200 flex items-center gap-1"><i data-lucide="heart" width="12"></i> æè´ˆ</button></div></div>))}</div></div>
                                <div><h3 className="text-sm font-bold text-slate-500 uppercase tracking-widest mb-3">å€‹äººè‡ªæ”œæ¸…å–®</h3><div className="grid gap-4">{myGear.map(item => (<div key={item.id} className="bg-slate-50 p-4 rounded-xl border border-slate-200 flex justify-between items-center"><div><p className="font-bold text-slate-700">{item.name}</p><p className="text-xs text-slate-500">ç‹€æ…‹: {item.status}</p></div></div>))}</div></div>
                            </div>
                        );
                    case 'life':
                        return (
                            <div className="p-6 max-w-4xl mx-auto animate-in fade-in">
                                <PageHeader title="ç”Ÿæ´»å¾Œå‹¤ä¿éšœ" icon="tent" color="text-orange-500" />
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{LIFE_SUPPORT_FACILITIES.map(fac => (<div key={fac.id} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm"><div className="flex justify-between items-start mb-4"><div className="flex items-center gap-3"><div className={`p-3 rounded-xl ${fac.type === 'food' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'}`}><i data-lucide={fac.type === 'food' ? 'utensils' : fac.type === 'shower' ? 'droplets' : 'zap'}></i></div><div><h4 className="font-bold text-slate-800">{fac.name}</h4><p className="text-xs text-slate-500 flex items-center gap-1"><i data-lucide="map-pin" width="10"></i> {fac.location}</p></div></div><span className={`px-2 py-1 rounded text-[10px] font-bold ${fac.status === 'é¡æ»¿' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{fac.status}</span></div><div className="flex justify-between items-end border-t border-slate-100 pt-3"><span className="text-xs font-bold text-slate-400">å®¹é‡</span><span className="text-sm font-bold text-slate-800">{fac.capacity}</span></div></div>))}</div>
                            </div>
                        );
                    default: return null;
                }
            };

            // Safety Bar Component (Persistent)
            const SafetyBar = ({ onSOS }) => {
                const [lastHeartbeat, setLastHeartbeat] = useState(0);
                useEffect(() => { const i = setInterval(() => setLastHeartbeat(p => p + 1), 60000); return () => clearInterval(i); }, []);
                return (
                    <div className="fixed bottom-0 left-0 right-0 bg-slate-900 text-white p-3 z-40 flex items-center justify-between shadow-2xl border-t border-slate-700">
                        <div className="flex items-center gap-4">
                            <div className="flex flex-col"><span className="text-[10px] text-slate-400 uppercase tracking-widest">å®‰å…¨å¿ƒè·³</span><div className="flex items-center gap-2"><span className="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse"></span><span className="text-sm font-bold text-green-400">é€£ç·šä¸­ ({lastHeartbeat}m å‰)</span></div></div>
                            <div className="h-8 w-px bg-slate-700 mx-2 hidden md:block"></div>
                            <div className="hidden md:flex flex-col"><span className="text-[10px] text-slate-400 uppercase tracking-widest">ç›®å‰ä½ç½®</span><span className="text-xs font-mono text-slate-300">24.123N, 121.456E</span></div>
                        </div>
                        <button onClick={onSOS} className="sos-btn rounded-full w-12 h-12 flex items-center justify-center font-black text-white text-xs border-2 border-white/20 hover:scale-105 transition-transform">SOS</button>
                    </div>
                );
            };

            if (!currentUser) return <LoginView onLogin={setCurrentUser} />;

            return (
                <div className="flex h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden">
                    <ToastContainer toasts={toasts} removeToast={(id) => setToasts(p => p.filter(t => t.id !== id))} />
                    
                    {/* Navigation */}
                    <nav className="w-20 md:w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-xl">
                        <div className="p-5 border-b border-slate-100 flex items-center gap-3">
                            <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-lg"><i data-lucide="command"></i></div>
                            <div className="hidden md:block"><h1 className="font-bold text-slate-800 leading-none">ResQ v5.0</h1><span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Kun Shan Univ.</span></div>
                        </div>
                        <div className="flex-1 py-6 px-3 space-y-1 overflow-y-auto">
                            <div className="px-4 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest hidden md:block">æŒ‡æ®ä¸­å¿ƒ</div>
                            <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'dashboard' ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}><i data-lucide="layout-dashboard" width="18"></i> <span className="hidden md:inline font-bold text-sm">æŒ‡æ®ç¸½è¦½</span></button>
                            <button onClick={() => setActiveTab('map')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'map' ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}><i data-lucide="map" width="18"></i> <span className="hidden md:inline font-bold text-sm">æˆ°æƒ…åœ°åœ–</span></button>
                            
                            <div className="px-4 mb-2 mt-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest hidden md:block">ç®¡ç†æ¨¡çµ„</div>
                            <button onClick={() => setActiveTab('volunteers')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'volunteers' ? 'bg-white text-blue-600 border border-blue-100 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><i data-lucide="users" width="18"></i> <span className="hidden md:inline font-bold text-sm">äººåŠ›ç®¡ç†</span></button>
                            <button onClick={() => setActiveTab('logistics')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'logistics' ? 'bg-white text-orange-600 border border-orange-100 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><i data-lucide="package" width="18"></i> <span className="hidden md:inline font-bold text-sm">å¾Œå‹¤èª¿åº¦</span></button>
                            
                            <div className="px-4 mb-2 mt-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest hidden md:block">å€‹äººèˆ‡å®‰å…¨</div>
                            <button onClick={() => setActiveTab('resource')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'resource' ? 'bg-white text-green-600 border border-green-100 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><i data-lucide="recycle" width="18"></i> <span className="hidden md:inline font-bold text-sm">è³‡æå¾ªç’°</span></button>
                            <button onClick={() => setActiveTab('life')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'life' ? 'bg-white text-purple-600 border border-purple-100 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><i data-lucide="coffee" width="18"></i> <span className="hidden md:inline font-bold text-sm">ç”Ÿæ´»å¾Œå‹¤</span></button>
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50/50">
                            <div className="flex items-center gap-3">
                                <div className={`w-9 h-9 rounded-full flex items-center justify-center text-white font-bold text-xs ${currentUser.color}`}>{currentUser.name[0]}</div>
                                <div className="hidden md:block overflow-hidden"><p className="text-xs font-bold text-slate-800 truncate">{currentUser.name}</p><button onClick={handleLogout} className="text-[10px] text-red-500 font-bold hover:underline">ç™»å‡ºç³»çµ±</button></div>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col min-w-0 relative">
                        <div className="flex-1 overflow-y-auto pb-20">
                            {renderContent()}
                        </div>
                        <SafetyBar onSOS={() => setIsSOSModalOpen(true)} />
                    </main>

                    {/* Modals */}
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={modalType === 'volunteer' ? 'ç™»éŒ„æ–°å¿—å·¥' : 'æ–°å¢å¾Œå‹¤éœ€æ±‚'}>
                        <form onSubmit={modalType === 'volunteer' ? handleVolunteerAdd : handleLogisticsAdd} className="space-y-4">
                            {modalType === 'volunteer' ? (
                                <>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">å§“å</label><input name="name" required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¼¸å…¥å…¨å" /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">è¯çµ¡é›»è©±</label><input name="phone" required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="09xx-xxx-xxx" /></div>
                                    </div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">å°ˆæ¥­æŠ€èƒ½</label><input name="skill" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚ï¼šç·Šæ€¥æ•‘è­· (EMT-1)" /></div>
                                </>
                            ) : (
                                <>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">éœ€æ±‚å“é …</label><input name="item" required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚ï¼šç¡è¢‹" /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">æ•¸é‡</label><input name="qty" type="number" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">å„ªå…ˆç´š</label><select name="priority" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none"><option>æ™®é€š</option><option>é«˜</option><option>ç·Šæ€¥</option></select></div>
                                    </div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">éœ€æ±‚å–®ä½</label><input name="from" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="å¦‚ï¼šAå€å®‰ç½®é»" /></div>
                                </>
                            )}
                            <div className="pt-4 flex justify-end gap-3">
                                <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-500 font-bold text-sm hover:bg-slate-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                                <button type="submit" className="px-6 py-2 bg-blue-600 text-white font-bold text-sm rounded-lg shadow-md hover:bg-blue-700 transition-colors">ç¢ºèªæ–°å¢</button>
                            </div>
                        </form>
                    </Modal>

                    {isSOSModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-red-900/90 backdrop-blur-md animate-in fade-in">
                            <div className="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl scale-100 animate-in zoom-in">
                                <div className="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><i data-lucide="alert-octagon" width="40" height="40"></i></div>
                                <h3 className="text-2xl font-black text-slate-900 mb-2">ç¢ºèªç™¼é€æ±‚æ•‘è¨Šè™Ÿï¼Ÿ</h3>
                                <p className="text-sm text-slate-500 mb-6">å°‡å‚³é€ç²¾ç¢ºåº§æ¨™èˆ‡éŒ„éŸ³è‡³æœ€è¿‘çš„æ•‘æ´å°çµ„èˆ‡æŒ‡æ®ä¸­å¿ƒã€‚</p>
                                <div className="space-y-3"><button onClick={() => { alert('æ±‚æ•‘è¨Šè™Ÿå·²ç™¼é€ï¼'); setIsSOSModalOpen(false); }} className="w-full py-4 bg-red-600 text-white rounded-xl font-black text-lg shadow-lg hover:bg-red-700">ç«‹å³ç™¼é€ SOS</button><button onClick={() => setIsSOSModalOpen(false)} className="w-full py-3 text-slate-400 font-bold hover:text-slate-600">å–æ¶ˆ (èª¤è§¸)</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
