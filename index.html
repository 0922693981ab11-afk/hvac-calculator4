<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>災害救助行動指揮系統 v8.2 - 指揮權轉移版</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React, ReactDOM & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; background-color: #f8fafc; }
        
        /* Glassmorphism & Animations */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .login-pattern { background-color: #f8fafc; background-image: radial-gradient(#94a3b8 0.5px, transparent 0.5px); background-size: 24px 24px; }
        .map-bg { background-image: url('https://api.mapbox.com/styles/v1/mapbox/light-v11/static/121.5,24.0,10,0/1200x800?access_token=none'); background-size: cover; background-position: center; }
        
        /* SOS & Mesh Animation */
        .sos-btn {
            background: radial-gradient(circle, #ef4444 0%, #b91c1c 100%);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: sos-pulse 2s infinite;
        }
        @keyframes sos-pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        
        /* Triage Colors */
        .triage-red { background-color: #ef4444; color: white; border: 2px solid #b91c1c; }
        .triage-yellow { background-color: #eab308; color: black; border: 2px solid #a16207; }
        .triage-green { background-color: #22c55e; color: white; border: 2px solid #15803d; }
        .triage-black { background-color: #1f2937; color: white; border: 2px solid #000000; }

        /* Mesh Network Indicator */
        .mesh-active { animation: mesh-pulse 3s infinite; }
        @keyframes mesh-pulse {
            0% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- i18n Translations ---
        const TRANSLATIONS = {
            'zh-TW': {
                appTitle: '災害救助行動指揮系統',
                appSubtitle: '整合 D2D 通訊、醫療檢傷與資源循環',
                login: {
                    title: '人員/單位 進場登錄',
                    quickLogin: '快速演示登入',
                    registration: '新單位報到註冊',
                    unitName: '單位名稱 (如: 台南特搜)',
                    personName: '人員姓名',
                    idNumber: '識別編號 (ID)',
                    roleSelect: '任務職掌',
                    submitReg: '提交報到資訊',
                    backToLogin: '返回登入'
                },
                nav: { dashboard: '指揮總覽', map: '戰情地圖', medical: '緊急醫療', volunteers: '人力管理', logistics: '後勤調度', social: '社群情資', resource: '資材循環', life: '生活後勤', logout: '登出', back: '返回上一頁' },
                stats: { manpower: '前線人力', requests: '待處理需求', triage: '檢傷總數', sensors: 'IoT 異常', recycle: '資材循環率', shelter: '避難負荷' },
                headers: { alert: '官方與社群警訊', gisControl: 'GIS 圖層', quickActions: '快速行動', triage: '大量傷患檢傷 (START)', mesh: 'D2D 網狀網路', social: '社群輿情監測', borrowed: '借用中資材', myGear: '個人自攜清單', lifeSupport: '生活後勤保障', transferCommand: '指揮權轉移程序' },
                actions: { scan: '掃碼', addVolunteer: '登錄志工', submitRequest: '提交需求', triage: '檢傷登錄', meshToggle: '切換通訊模式', verify: '查證', ignore: '忽略', return: '歸還', donate: '捐贈', sign: '簽到', approve: '核准', receive: '簽收', confirmAdd: '確認新增', cancel: '取消', transfer: '移交指揮權', confirmTransfer: '確認移交' },
                form: { name: '姓名', phone: '聯絡電話', skill: '專業技能', item: '需求品項', qty: '數量', priority: '優先級', from: '需求單位', targetUnit: '接收單位', reason: '移交原因', placeholderName: '輸入全名', placeholderPhone: '09xx-xxx-xxx', placeholderSkill: '如：緊急救護 (EMT-1)', placeholderItem: '如：睡袋', placeholderFrom: '如：A區安置點' },
                triage: { red: '第一優先 (紅)', yellow: '第二優先 (黃)', green: '第三優先 (綠)', black: '死亡 (黑)', desc: '依據呼吸、循環、意識 (RPM) 快速分類' },
                mesh: { active: 'Mesh 網狀網路啟用', inactive: '網際網路連線中', desc: '基礎設施中斷時，透過藍牙/WiFi Direct 進行近接中繼傳輸。' },
                safety: { locationConsentTitle: '開啟位置回報', locationConsentDesc: '為了您的安全，系統需存取 GPS。資料僅供本次任務使用。', agree: '同意並開啟', heartbeat: '安全心跳', connected: '系統連線中', location: '定位服務', locationOff: '未分享', locationOn: '即時回報中', confirmSOS: '確認發送求救訊號？', sosDesc: '將傳送精確座標與錄音至最近的救援小組與指揮中心。', cancel: '取消', send: '立即發送 SOS' },
                status: { overdue: '逾時', checkedIn: '已報到', booking: '預約中', pending: '待處理', shipping: '運送中', arrived: '已送達', urgent: '緊急', Normal: '普通', High: '高', Urgent: '緊急' },
                designerLabel: '設計者 吳啓仲'
            },
            'en-US': {
                appTitle: 'Disaster Relief Command System',
                appSubtitle: 'Integrated D2D Comms, EMS Triage & Resource Circularity',
                login: {
                    title: 'Personnel / Unit Login',
                    quickLogin: 'Quick Demo Login',
                    registration: 'New Unit Registration',
                    unitName: 'Unit Name (e.g. SAR Team A)',
                    personName: 'Full Name',
                    idNumber: 'ID Number',
                    roleSelect: 'Role / Function',
                    submitReg: 'Submit Registration',
                    backToLogin: 'Back to Login'
                },
                nav: { dashboard: 'Dashboard', map: 'Situation Map', medical: 'Medical EMS', volunteers: 'Volunteers', logistics: 'Logistics', social: 'Social Intel', resource: 'Circularity', life: 'Life Support', logout: 'Logout', back: 'Go Back' },
                stats: { manpower: 'Manpower', requests: 'Pending Req', triage: 'Triage Count', sensors: 'IoT Alerts', recycle: 'Recycle Rate', shelter: 'Shelter Load' },
                headers: { alert: 'Official & Social Alerts', gisControl: 'GIS Layers', quickActions: 'Quick Actions', triage: 'Mass Casualty Triage', mesh: 'D2D Mesh Network', social: 'Social Media Monitoring', borrowed: 'Borrowed Gear', myGear: 'My Gear', lifeSupport: 'Life Support', transferCommand: 'Command Transfer Protocol' },
                actions: { scan: 'Scan', addVolunteer: 'Add Volunteer', submitRequest: 'Request', triage: 'Log Triage', meshToggle: 'Toggle Comms', verify: 'Verify', ignore: 'Ignore', return: 'Return', donate: 'Donate', sign: 'Check-In', approve: 'Approve', receive: 'Receive', confirmAdd: 'Confirm Add', cancel: 'Cancel', transfer: 'Transfer Command', confirmTransfer: 'Confirm Transfer' },
                form: { name: 'Name', phone: 'Phone', skill: 'Skill', item: 'Item', qty: 'Qty', priority: 'Priority', from: 'From Unit', targetUnit: 'Target Unit', reason: 'Reason', placeholderName: 'Full Name', placeholderPhone: 'Phone Number', placeholderSkill: 'e.g. EMT-1', placeholderItem: 'e.g. Sleeping Bag', placeholderFrom: 'e.g. Zone A' },
                triage: { red: 'Immediate (Red)', yellow: 'Delayed (Yellow)', green: 'Minor (Green)', black: 'Deceased (Black)', desc: 'Rapid sorting based on RPM (Respiration, Perfusion, Mental Status)' },
                mesh: { active: 'Mesh Network Active', inactive: 'Internet Connected', desc: 'Use Bluetooth/WiFi Direct for proximity relay when infra fails.' },
                safety: { locationConsentTitle: 'Enable Tracking', locationConsentDesc: 'GPS access required for safety. Data used for mission only.', agree: 'Agree & Enable', heartbeat: 'Heartbeat', connected: 'Connected', location: 'Location Svc', locationOff: 'Off', locationOn: 'Tracking', confirmSOS: 'Confirm SOS Signal?', sosDesc: 'Transmitting coords & audio to Rescue Team.', cancel: 'Cancel', send: 'Send SOS Now' },
                status: { overdue: 'Overdue', checkedIn: 'Checked-In', booking: 'Booking', pending: 'Pending', shipping: 'Shipping', arrived: 'Arrived', urgent: 'Urgent', Normal: 'Normal', High: 'High', Urgent: 'Urgent' },
                designerLabel: 'Designer: Wu Qi-Zhong'
            }
        };

        // --- Mock Data ---
        const ROLES_OPTIONS = [
            { id: 'ic', name: '指揮官 (IC)', icon: 'shield-check', color: 'bg-red-600' },
            { id: 'ops', name: '作業組 (Ops)', icon: 'activity', color: 'bg-blue-600' },
            { id: 'log', name: '後勤組 (Log)', icon: 'package', color: 'bg-orange-500' },
            { id: 'vol', name: '志工隊 (Vol)', icon: 'users', color: 'bg-slate-600' },
        ];

        const TRANSFER_TARGETS = [
            '中央災害應變中心 (CEOC)',
            '內政部消防署 (NFA)',
            '國防部 (MND)',
            '花蓮縣災害應變中心'
        ];

        const SOCIAL_FEED = [
            { id: 1, source: 'Facebook', user: '民眾A', content: '體育館後方好像有圍牆倒塌，壓到車子！', time: '10:55', status: '待查證', type: 'risk' },
            { id: 2, source: 'Line群組', user: '里長B', content: 'C區水管破裂，需要沙包支援。', time: '10:50', status: '已證實', type: 'logistics' },
            { id: 3, source: 'PTT', user: '鄉民C', content: '聽說大橋斷了？求證！', time: '10:48', status: '已闢謠', type: 'rumor' }
        ];
        const IOT_ALERTS = [
            { id: 1, type: 'InSAR', location: '山腳斷層監測站', value: '位移 2.5cm', status: 'Warning', desc: '地層變位異常' },
            { id: 2, type: 'WaterLevel', location: '中游觀測井', value: '水位 85%', status: 'Normal', desc: '水位警戒線下' }
        ];
        const TRIAGE_DATA = [
            { id: 1, code: 'T-001', level: 'red', condition: '大量出血, 意識不清', location: 'Zone A', time: '11:00' },
            { id: 2, code: 'T-002', level: 'yellow', condition: '腿部骨折, 意識清楚', location: 'Zone A', time: '11:05' },
            { id: 3, code: 'T-003', level: 'green', condition: '擦傷', location: 'Zone B', time: '11:10' }
        ];
        const LIFE_SUPPORT_FACILITIES = [
            { id: 'f1', name: 'A區熱食站', type: 'food', status: '供餐中', capacity: '50 left', location: 'Gym Entrance' },
            { id: 'f2', name: 'B區淋浴間', type: 'shower', status: '排隊中', capacity: 'Wait 15m', location: 'North Field' },
            { id: 'f3', name: '志工休息帳', type: 'sleep', status: '額滿', capacity: 'Full', location: 'Campus 2' },
            { id: 'f4', name: '行動充電站', type: 'power', status: '可用', capacity: '80%', location: 'HQ Side' },
        ];

        // --- Components ---
        const ToastContainer = ({ toasts, removeToast }) => (
            <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[80] flex flex-col gap-2 w-full max-w-sm px-4 pointer-events-none">
                {toasts.map(toast => (
                    <div key={toast.id} className="toast-enter pointer-events-auto bg-slate-800 text-white shadow-xl rounded-lg p-3 flex items-center gap-3">
                        <div className={`p-1 rounded-full ${toast.type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`}><i data-lucide={toast.type === 'success' ? 'check' : 'info'} width="14"></i></div>
                        <div className="flex-1"><p className="text-sm font-bold">{toast.title}</p><p className="text-xs text-slate-300">{toast.message}</p></div>
                    </div>
                ))}
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl scale-100 animate-in zoom-in-95">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full text-slate-500"><i data-lucide="x" width="20"></i></button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ label, val, unit, icon, color }) => (
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-all">
                <div className={`p-3 rounded-xl ${color} bg-opacity-10 text-${color.split('-')[1]}-600`}>
                    <i data-lucide={icon} className={color.replace('bg-', 'text-')}></i>
                </div>
                <div><p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">{label}</p><p className="text-2xl font-black text-slate-800">{val} <span className="text-xs text-slate-400 font-normal">{unit}</span></p></div>
            </div>
        );

        const PageHeader = ({ title, icon, color, btnText, onBtnClick }) => (
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2"><i data-lucide={icon} className={color}></i> {title}</h2>
                {btnText && <button onClick={onBtnClick} className="px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-lg text-sm font-bold shadow-lg flex items-center gap-2 transition-all"><i data-lucide="plus" width="16"></i> {btnText}</button>}
            </div>
        );

        const StatusBadge = ({ status, lang }) => {
            const t = TRANSLATIONS[lang].status;
            // Enhanced mapping to include priorities
            const statusMap = { 
                '逾時': t.overdue, 'Overdue': t.overdue,
                '已報到': t.checkedIn, 'Checked-In': t.checkedIn,
                '預約中': t.booking, 'Booking': t.booking,
                '待處理': t.pending, 'Pending': t.pending,
                '運送中': t.shipping, 'Shipping': t.shipping,
                '已送達': t.arrived, 'Arrived': t.arrived,
                '緊急': t.urgent, 'Urgent': t.urgent,
                'Normal': t.Normal || 'Normal', 'High': t.High || 'High' // Fallbacks
            };
            const displayStatus = statusMap[status] || status;
            
            const colors = { 
                [t.overdue]: 'bg-red-50 text-red-600 border-red-100', 
                [t.checkedIn]: 'bg-green-50 text-green-600 border-green-100', 
                [t.booking]: 'bg-blue-50 text-blue-600 border-blue-100', 
                [t.urgent]: 'bg-red-600 text-white border-red-600',
                [t.High]: 'bg-orange-100 text-orange-700 border-orange-200' 
            };
            return <span className={`px-2.5 py-1 rounded-md text-xs font-bold border ${colors[displayStatus] || 'bg-slate-50 text-slate-500 border-slate-100'}`}>{displayStatus}</span>;
        };

        const EmptyState = ({ text }) => (
            <div className="p-12 text-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/30">
                <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300"><i data-lucide="inbox" width="24"></i></div>
                <p className="text-slate-400 font-medium">{text}</p>
            </div>
        );

        // --- Login / Registration View ---
        const LoginView = ({ onLogin, lang, setLang }) => {
            const t = TRANSLATIONS[lang];
            const [mode, setMode] = useState('login'); 
            const [regData, setRegData] = useState({ unit: '', name: '', id: '', role: 'vol' });

            useEffect(() => { lucide.createIcons(); }, []);

            const handleRegister = (e) => {
                e.preventDefault();
                const roleConfig = ROLES_OPTIONS.find(r => r.id === regData.role) || ROLES_OPTIONS[3];
                const userData = {
                    id: regData.role,
                    name: regData.name,
                    unit: regData.unit,
                    idNumber: regData.id,
                    icon: roleConfig.icon,
                    color: roleConfig.color
                };
                onLogin(userData);
            };

            return (
                <div className="h-screen w-full flex items-center justify-center login-pattern p-4 relative">
                    <button onClick={() => setLang(lang === 'zh-TW' ? 'en-US' : 'zh-TW')} className="absolute top-6 right-6 bg-white px-3 py-1 rounded shadow text-sm font-bold border border-slate-200">{lang === 'zh-TW' ? 'English' : '中文'}</button>
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-lg w-full">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white shadow-lg"><i data-lucide="shield-check" width="32"></i></div>
                            <h1 className="text-2xl font-black mb-1 text-slate-800">ResQ v8.2</h1>
                            <p className="text-xs text-slate-500 font-bold uppercase tracking-widest">{t.appSubtitle}</p>
                        </div>

                        {mode === 'login' ? (
                            <>
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 border-b border-slate-100 pb-2">{t.login.quickLogin}</h3>
                                <div className="space-y-3 mb-6">
                                    {ROLES_OPTIONS.map(role => (
                                        <button key={role.id} onClick={() => onLogin({...role, unit: role.id === 'ic' ? '指揮中心' : '作業隊', name: role.id === 'ic' ? '指揮官' : 'User Demo'})} className="w-full flex items-center gap-4 p-4 rounded-xl border border-slate-100 bg-slate-50 hover:bg-slate-900 hover:text-white transition-all text-left group">
                                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-white ${role.color}`}><i data-lucide={role.icon}></i></div>
                                            <div className="flex-1"><p className="font-bold text-sm">{role.name}</p></div>
                                            <i data-lucide="chevron-right" className="opacity-0 group-hover:opacity-100 transition-all"></i>
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setMode('register')} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="user-plus" width="18"></i> {t.login.registration}
                                </button>
                            </>
                        ) : (
                            <form onSubmit={handleRegister} className="animate-in slide-in-from-right duration-300">
                                <div className="flex items-center gap-2 mb-6">
                                    <button type="button" onClick={() => setMode('login')} className="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="arrow-left" width="20"></i></button>
                                    <h3 className="text-lg font-bold text-slate-800">{t.login.registration}</h3>
                                </div>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">{t.login.unitName}</label><input required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={regData.unit} onChange={e=>setRegData({...regData, unit:e.target.value})} placeholder="例如: 台北市搜救隊" /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">{t.login.personName}</label><input required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={regData.name} onChange={e=>setRegData({...regData, name:e.target.value})} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">{t.login.idNumber}</label><input required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={regData.id} onChange={e=>setRegData({...regData, id:e.target.value})} placeholder="例如: P-1024" /></div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">{t.login.roleSelect}</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {ROLES_OPTIONS.map(role => (
                                                <button type="button" key={role.id} onClick={() => setRegData({...regData, role: role.id})} className={`p-2 rounded-lg border text-xs font-bold flex items-center gap-2 ${regData.role === role.id ? 'bg-slate-900 text-white border-slate-900' : 'bg-white border-slate-200 text-slate-600'}`}>
                                                    <div className={`w-2 h-2 rounded-full ${role.color}`}></div>{role.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" className="w-full mt-6 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg hover:bg-green-700 transition-all">{t.login.submitReg}</button>
                            </form>
                        )}

                        <div className="mt-8 flex items-center justify-center gap-2 text-[10px] text-slate-400 font-bold border-t border-slate-100 pt-4">
                            <span>{t.designerLabel}</span>
                            <a href="mailto:0922693981ab11@gmail.com?subject=[ResQ系統回饋]" title="聯繫設計者" className="hover:text-blue-500 transition-colors">
                                <i data-lucide="mail" width="12"></i>
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Sub-Views ---
        
        const DashboardView = ({ stats, lang, onQuickAction, isIC, onTransfer }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="p-6 max-w-7xl mx-auto animate-in fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                        <div>
                            <h2 className="text-3xl font-black text-slate-800">{t.nav.dashboard}</h2>
                            <p className="text-sm text-slate-500 font-medium mt-1">ResQ v8.2 <span className="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded text-xs font-bold ml-2">Level 2</span></p>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="hidden md:flex px-3 py-1.5 bg-white border border-green-200 text-green-700 rounded-full text-xs font-bold items-center gap-2 shadow-sm"><span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online</span>
                            {/* Command Transfer Button for IC */}
                            {isIC && (
                                <button onClick={onTransfer} className="px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold shadow-lg hover:bg-slate-800 transition-all flex items-center gap-2 border border-slate-700">
                                    <i data-lucide="arrow-right-left" width="14"></i> {t.actions.transfer}
                                </button>
                            )}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        {stats.map((stat, idx) => <StatCard key={idx} {...stat} />)}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="zap" width="16" className="text-yellow-500"></i> {t.headers.quickActions}</h3>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => onQuickAction('triage')} className="p-4 bg-red-50 hover:bg-red-100 rounded-xl flex flex-col items-center justify-center gap-2 transition-colors border border-red-100"><div className="w-10 h-10 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><i data-lucide="activity"></i></div><span className="text-xs font-bold text-slate-700">{t.actions.triage}</span></button>
                                <button onClick={() => onQuickAction('scan')} className="p-4 bg-slate-50 hover:bg-slate-100 rounded-xl flex flex-col items-center justify-center gap-2 transition-colors border border-slate-100"><div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i data-lucide="qr-code"></i></div><span className="text-xs font-bold text-slate-700">{t.actions.scan}</span></button>
                                <button onClick={() => onQuickAction('volunteer')} className="p-4 bg-slate-50 hover:bg-slate-100 rounded-xl flex flex-col items-center justify-center gap-2 transition-colors border border-slate-100"><div className="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i data-lucide="user-plus"></i></div><span className="text-xs font-bold text-slate-700">{t.actions.addVolunteer}</span></button>
                                <button onClick={() => onQuickAction('logistics')} className="p-4 bg-slate-50 hover:bg-slate-100 rounded-xl flex flex-col items-center justify-center gap-2 transition-colors border border-slate-100"><div className="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center"><i data-lucide="package-plus"></i></div><span className="text-xs font-bold text-slate-700">{t.actions.submitRequest}</span></button>
                            </div>
                        </div>
                        <div className="lg:col-span-2 bg-slate-900 text-white rounded-2xl p-6 relative overflow-hidden shadow-xl flex flex-col justify-between">
                            <div className="relative z-10">
                                <h3 className="text-lg font-bold flex items-center gap-2 mb-4"><i data-lucide="bell" className="text-yellow-400"></i> {t.headers.alert}</h3>
                                <div className="space-y-3 h-64 overflow-y-auto pr-2 custom-scrollbar">
                                    {IOT_ALERTS.map(alert => (<div key={alert.id} className="bg-red-500/10 p-3 rounded-xl border border-red-500/30 flex gap-3 items-center backdrop-blur-sm"><i data-lucide="radio" className="text-red-400" width="18"></i><div className="flex-1"><p className="text-xs font-bold text-red-200">IoT: {alert.type}</p><p className="text-sm font-bold text-white">{alert.location} - {alert.value}</p></div><span className="text-[10px] bg-red-500 px-2 py-1 rounded font-bold shadow">{alert.status}</span></div>))}
                                    {SOCIAL_FEED.map(feed => (<div key={feed.id} className="bg-white/10 p-3 rounded-xl border border-white/10 flex gap-3 backdrop-blur-sm"><div className="p-2 bg-blue-500/20 rounded-lg text-blue-300 mt-1"><i data-lucide="message-circle" width="16"></i></div><div className="flex-1"><div className="flex justify-between items-center mb-1"><span className="text-[10px] text-slate-400">{feed.source} • {feed.user}</span><span className="text-[10px] text-slate-400">{feed.time}</span></div><p className="text-sm text-slate-200">{feed.content}</p></div><button className="text-[10px] bg-white/20 hover:bg-white/30 px-3 py-1 rounded h-fit self-center transition-colors border border-white/20">{t.actions.verify}</button></div>))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MapView = ({ mapLayers, toggleLayer, isSharing, lang }) => (
            <div className="h-full relative bg-slate-200 w-full animate-in fade-in">
                <div className="absolute inset-0 map-bg opacity-90"></div>
                {isSharing && <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center animate-in zoom-in duration-300"><div className="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg relative z-10"></div><div className="w-12 h-12 bg-blue-500/20 rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 animate-ping"></div><div className="mt-2 px-2 py-1 bg-white/90 backdrop-blur rounded-md shadow-md text-[10px] font-bold text-slate-700">Me</div></div>}
                <div className="absolute top-6 right-6 bg-white/95 backdrop-blur rounded-2xl p-4 shadow-xl border border-slate-200 flex flex-col gap-3 z-10 w-48">
                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">{TRANSLATIONS[lang].headers.gisControl}</span>
                    {Object.keys(mapLayers).map(key => (<button key={key} onClick={() => toggleLayer(key)} className={`flex items-center justify-between px-3 py-2.5 rounded-xl text-xs font-bold transition-all ${mapLayers[key] ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-50 text-slate-400 border border-slate-100'}`}><span className="flex items-center gap-2"><span className={`w-2 h-2 rounded-full ${key === 'hazard' ? 'bg-red-500' : key === 'resources' ? 'bg-blue-500' : 'bg-green-500'}`}></span>{key === 'hazard' ? 'Hazard' : key === 'resources' ? 'Resource' : 'Volunteer'}</span>{mapLayers[key] && <i data-lucide="check" width="14"></i>}</button>))}
                </div>
                {mapLayers.hazard && <div className="absolute top-1/3 left-1/4 animate-pulse"><div className="w-24 h-24 bg-red-500/20 rounded-full flex items-center justify-center border-2 border-red-500 border-dashed"><i data-lucide="alert-triangle" className="text-red-600 w-8 h-8"></i></div></div>}
            </div>
        );

        const MedicalView = ({ lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="p-6 max-w-6xl mx-auto animate-in fade-in">
                    <PageHeader title={t.nav.medical} icon="activity" color="text-red-600" btnText={t.actions.triage} onBtnClick={() => {}} />
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-2 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs border-b border-slate-200"><tr><th className="px-6 py-4">ID</th><th className="px-6 py-4">Status</th><th className="px-6 py-4">Condition</th><th className="px-6 py-4">Loc</th></tr></thead><tbody className="divide-y divide-slate-100">{TRIAGE_DATA.map(pt => (<tr key={pt.id} className="hover:bg-slate-50"><td className="px-6 py-4 font-mono font-bold text-slate-700">{pt.code}</td><td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs font-bold triage-${pt.level}`}>{t.triage[pt.level]}</span></td><td className="px-6 py-4 text-slate-600">{pt.condition}</td><td className="px-6 py-4 text-slate-500 text-xs">{pt.location}</td></tr>))}</tbody></table>
                        </div>
                        <div className="bg-slate-50 border border-slate-200 rounded-2xl p-6 h-fit"><h3 className="text-sm font-bold text-slate-500 uppercase mb-4">Hospital Capacity</h3><div className="space-y-4"><div><div className="flex justify-between text-sm mb-1"><span className="font-bold text-slate-700">Tzu Chi</span><span className="text-red-500 font-bold">Full</span></div><div className="w-full bg-slate-200 rounded-full h-2"><div className="bg-red-500 h-2 rounded-full" style={{width: '95%'}}></div></div></div></div></div>
                    </div>
                </div>
            );
        };

        const VolunteersView = ({ data, onAdd, onUpdate, onDelete, lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="max-w-6xl mx-auto animate-in fade-in p-6">
                    <PageHeader title={t.nav.volunteers} icon="users" color="text-blue-600" btnText={t.actions.addVolunteer} onBtnClick={onAdd} />
                    <div className="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden overflow-x-auto">
                        <table className="w-full text-sm text-left min-w-[600px]"><thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs border-b border-slate-200"><tr><th className="px-6 py-4">Name / Contact</th><th className="px-6 py-4">Skill</th><th className="px-6 py-4">Time</th><th className="px-6 py-4">Status</th><th className="px-6 py-4 text-right">Action</th></tr></thead><tbody className="divide-y divide-slate-100">{data.length === 0 ? <tr><td colSpan="5"><EmptyState text="No Data" /></td></tr> : data.map(res => (<tr key={res.id} className="hover:bg-slate-50 transition-colors group"><td className="px-6 py-4"><div className="font-bold text-slate-800">{res.name}</div><div className="text-xs text-slate-400 font-mono">{res.phone}</div></td><td className="px-6 py-4"><span className="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs border border-slate-200">{res.skill}</span></td><td className="px-6 py-4 text-slate-500 font-mono text-xs">{new Date(res.time).toLocaleString()}</td><td className="px-6 py-4"><StatusBadge status={res.status} lang={lang} /></td><td className="px-6 py-4 text-right"><div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">{res.status !== '已報到' && <button onClick={() => onUpdate(res.id, '已報到')} className="px-2 py-1 bg-green-50 text-green-600 rounded border border-green-200 text-xs font-bold hover:bg-green-100">{t.actions.sign}</button>}<button onClick={() => onDelete(res.id)} className="p-1 text-slate-400 hover:text-red-500"><i data-lucide="trash-2" width="16"></i></button></div></td></tr>))}</tbody></table>
                    </div>
                </div>
            );
        };

        const LogisticsView = ({ data, onAdd, onUpdate, lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="max-w-6xl mx-auto animate-in fade-in p-6">
                    <PageHeader title={t.nav.logistics} icon="package" color="text-orange-500" btnText={t.actions.submitRequest} onBtnClick={onAdd} />
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        {data.length === 0 ? <div className="col-span-full"><EmptyState text="No Requests" /></div> : data.map(req => (<div key={req.id} className="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group"><div className={`absolute left-0 top-0 bottom-0 w-1 ${req.priority === '緊急' ? 'bg-red-500' : 'bg-slate-300'}`}></div><div className="flex justify-between items-start mb-3 pl-2"><h4 className="font-bold text-slate-800 text-lg">{req.item}</h4><StatusBadge status={req.priority} lang={lang} /></div><div className="pl-2 space-y-2 text-sm text-slate-500"><div className="flex justify-between"><span>Qty: <strong className="text-slate-800">{req.qty}</strong></span><span>From: {req.from}</span></div><div className="flex justify-between items-center pt-3 border-t border-slate-100"><span className="text-xs font-bold text-blue-600"><StatusBadge status={req.status} lang={lang} /></span><div className="flex gap-2">{req.status === '待處理' && <button onClick={() => onUpdate(req.id, '運送中')} className="px-3 py-1 bg-blue-600 text-white rounded text-xs font-bold hover:bg-blue-700">{t.actions.approve}</button>}{req.status === '運送中' && <button onClick={() => onUpdate(req.id, '已送達')} className="px-3 py-1 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700">{t.actions.receive}</button>}</div></div></div></div>))}
                    </div>
                </div>
            );
        };

        const ResourceView = ({ myGear, borrowedGear, onReturn, onScan, lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="p-6 max-w-4xl mx-auto animate-in fade-in">
                    <PageHeader title={t.nav.resource} icon="recycle" color="text-green-600" btnText={t.actions.scan} onBtnClick={onScan} />
                    <div className="mb-8"><h3 className="text-sm font-bold text-slate-500 uppercase tracking-widest mb-3">{t.headers.borrowed}</h3><div className="grid gap-4">{borrowedGear.length === 0 ? <EmptyState text="Empty" /> : borrowedGear.map(item => (<div key={item.id} className="bg-white p-4 rounded-xl border border-blue-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center relative overflow-hidden gap-4"><div className="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div><div><p className="font-bold text-slate-800">{item.name}</p><p className="text-xs text-slate-500">Src: {item.source}</p></div><div className="flex gap-2 w-full md:w-auto"><button onClick={() => onReturn(item.id, false)} className="flex-1 md:flex-none px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">{t.actions.return}</button><button onClick={() => onReturn(item.id, true)} className="flex-1 md:flex-none px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-xs font-bold hover:bg-green-200 border border-green-200 flex items-center justify-center gap-1"><i data-lucide="heart" width="12"></i> {t.actions.donate}</button></div></div>))}</div></div>
                    <div><h3 className="text-sm font-bold text-slate-500 uppercase tracking-widest mb-3">{t.headers.myGear}</h3><div className="grid gap-4">{myGear.length === 0 ? <EmptyState text="Empty" /> : myGear.map(item => (<div key={item.id} className="bg-slate-50 p-4 rounded-xl border border-slate-200 flex justify-between items-center"><div><p className="font-bold text-slate-700">{item.name}</p><p className="text-xs text-slate-500">Status: {item.status}</p></div></div>))}</div></div>
                </div>
            );
        };

        const LifeView = ({ lang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="p-6 max-w-4xl mx-auto animate-in fade-in">
                    <PageHeader title={t.headers.lifeSupport} icon="tent" color="text-orange-500" />
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{LIFE_SUPPORT_FACILITIES.map(fac => (<div key={fac.id} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow"><div className="flex justify-between items-start mb-4"><div className="flex items-center gap-3"><div className={`p-3 rounded-xl ${fac.type === 'food' ? 'bg-orange-100 text-orange-600' : fac.type === 'shower' ? 'bg-blue-100 text-blue-600' : 'bg-yellow-100 text-yellow-600'}`}><i data-lucide={fac.type === 'food' ? 'utensils' : fac.type === 'shower' ? 'droplets' : 'zap'}></i></div><div><h4 className="font-bold text-slate-800">{fac.name}</h4><p className="text-xs text-slate-500 flex items-center gap-1"><i data-lucide="map-pin" width="10"></i> {fac.location}</p></div></div><span className={`px-2 py-1 rounded text-[10px] font-bold ${fac.status === '額滿' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{fac.status}</span></div><div className="flex justify-between items-end border-t border-slate-100 pt-3"><span className="text-xs font-bold text-slate-400">Cap</span><span className="text-sm font-bold text-slate-800">{fac.capacity}</span></div></div>))}</div>
                </div>
            );
        };

        const SafetyBar = ({ onSOS, lang, isSharing, toggleSharing, isMeshActive, toggleMesh }) => {
            const t = TRANSLATIONS[lang].safety;
            const tm = TRANSLATIONS[lang].mesh;
            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-3 z-40 flex items-center justify-between shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                    <div className="flex items-center gap-4 md:gap-6 px-2 overflow-x-auto">
                        <button onClick={toggleMesh} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${isMeshActive ? 'bg-purple-100 text-purple-700 border-purple-200 mesh-active' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><i data-lucide={isMeshActive ? "network" : "wifi"} width="14"></i><span className="whitespace-nowrap">{isMeshActive ? tm.active : tm.inactive}</span></button>
                        <button onClick={toggleSharing} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${isSharing ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-slate-50 text-slate-400 border-slate-200'}`}><i data-lucide={isSharing ? "map-pin" : "map-pin-off"} width="14"></i><span className="whitespace-nowrap">{isSharing ? t.locationOn : t.locationOff}</span></button>
                    </div>
                    <button onClick={onSOS} className="sos-btn rounded-xl px-5 py-2.5 flex items-center justify-center font-black text-white text-sm shadow-lg hover:scale-105 transition-transform active:scale-95 gap-2 whitespace-nowrap"><i data-lucide="alert-octagon" width="18"></i> SOS</button>
                </div>
            );
        };

        // --- Main App Logic ---
        const App = () => {
            const [lang, setLang] = useState('zh-TW');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [history, setHistory] = useState(['dashboard']); // History Stack
            const [currentUser, setCurrentUser] = useState(null);
            
            const [isMeshActive, setIsMeshActive] = useState(false);
            const [isLocationSharing, setIsLocationSharing] = useState(false);
            const [toasts, setToasts] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalType, setModalType] = useState(null);

            // Data
            const [reservations, setReservations] = useState([{ id: 1, name: '王小明', phone: '0912-345-678', skill: 'USAR', time: new Date().toISOString(), status: '逾時' }]);
            const [requests, setRequests] = useState([{ id: 1, item: '發電機 5KW', qty: 2, from: 'HQ', status: '待處理', priority: '緊急' }]);
            const [myGear, setMyGear] = useState([{ id: 'g1', name: '個人頭燈 (LED)', type: '自攜', status: '持有中', condition: 'A' }]);
            const [borrowedGear, setBorrowedGear] = useState([{ id: 'b1', name: '無線電', source: 'Logistics', status: 'In Use' }]);
            
            // Command Transfer State
            const [commander, setCommander] = useState('林局長');

            useEffect(() => { lucide.createIcons(); }, [activeTab, isMeshActive, currentUser, reservations, requests, myGear]);

            const addToast = (title, message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, title, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };

            const handleLogout = () => { 
                setCurrentUser(null); 
                setActiveTab('dashboard'); 
                setHistory(['dashboard']); 
            };

            // Navigation Helpers
            const navigateTo = (tab) => {
                if (activeTab === tab) return;
                setActiveTab(tab);
                setHistory(prev => [...prev, tab]);
            };

            const goBack = () => {
                if (history.length > 1) {
                    const newHistory = history.slice(0, -1);
                    setHistory(newHistory);
                    setActiveTab(newHistory[newHistory.length - 1]);
                }
            };

            // Handlers
            const handleVolunteerAdd = (e) => { 
                e.preventDefault(); 
                const fd = new FormData(e.target);
                setReservations(p => [...p, { 
                    id: Date.now(), 
                    name: fd.get('name'), 
                    phone: fd.get('phone'), 
                    skill: fd.get('skill'), 
                    time: new Date().toISOString(), 
                    status: '預約中' 
                }]); 
                addToast('Success', 'Volunteer Added'); 
                setIsModalOpen(false); 
            };

            const handleLogisticsAdd = (e) => { 
                e.preventDefault(); 
                const fd = new FormData(e.target);
                setRequests(p => [...p, { 
                    id: Date.now(), 
                    item: fd.get('item'), 
                    qty: fd.get('qty'), 
                    from: fd.get('from'), 
                    status: '待處理', 
                    priority: fd.get('priority') 
                }]); 
                addToast('Success', 'Request Submitted'); 
                setIsModalOpen(false); 
            };

            const handleGearReturn = (id, isDonating) => { if(confirm('Return?')) { setBorrowedGear(p => p.filter(i => i.id !== id)); addToast('Success', isDonating ? 'Returned & Donated' : 'Returned'); } };

            // Command Transfer Handler
            const handleTransfer = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const target = fd.get('target');
                setCommander(target); // Update commander name
                addToast('System', `指揮權已移交至: ${target}`, 'info');
                setIsModalOpen(false);
            };

            const renderContent = () => {
                const props = { lang, onQuickAction: (action) => {
                    if (action === 'triage') { setModalType('triage'); setIsModalOpen(true); }
                    else if (action === 'scan') addToast('Camera', 'Scanning QR...');
                    else if (action === 'map') navigateTo('map');
                    else if (action === 'volunteer') { setModalType('volunteer'); setIsModalOpen(true); }
                    else if (action === 'logistics') { setModalType('logistics'); setIsModalOpen(true); }
                }};

                switch(activeTab) {
                    case 'dashboard': return <DashboardView stats={[
                        { label: TRANSLATIONS[lang].stats.manpower, val: reservations.length + 120, unit: 'Ppl', icon: 'users', color: 'bg-blue-100 text-blue-600' },
                        { label: TRANSLATIONS[lang].stats.triage, val: '12', unit: 'Case', icon: 'activity', color: 'bg-red-100 text-red-600' }, 
                        { label: TRANSLATIONS[lang].stats.sensors, val: '2', unit: 'Alert', icon: 'radio', color: 'bg-orange-100 text-orange-600' }, 
                        { label: TRANSLATIONS[lang].stats.recycle, val: '89', unit: '%', icon: 'recycle', color: 'bg-green-100 text-green-600' }
                    ]} {...props} isIC={currentUser?.id === 'ic'} onTransfer={() => {setModalType('transfer'); setIsModalOpen(true);}} />;
                    case 'medical': return <MedicalView lang={lang} />;
                    case 'social': return <SocialView lang={lang} />;
                    case 'map': return <MapView mapLayers={{hazard:true, resources:true, volunteers:true}} toggleLayer={() => {}} isSharing={isLocationSharing} lang={lang} />;
                    case 'volunteers': return <VolunteersView data={reservations} onAdd={() => {setModalType('volunteer'); setIsModalOpen(true);}} onUpdate={(id, status) => {setReservations(p => p.map(i => i.id === id ? {...i, status} : i)); addToast('Updated', 'Status Changed');}} onDelete={(id) => setReservations(p => p.filter(i => i.id !== id))} lang={lang} />;
                    case 'logistics': return <LogisticsView data={requests} onAdd={() => {setModalType('logistics'); setIsModalOpen(true);}} onUpdate={(id, status) => {setRequests(p => p.map(i => i.id === id ? {...i, status} : i)); addToast('Updated', 'Status Changed');}} lang={lang} />;
                    case 'resource': return <ResourceView myGear={myGear} borrowedGear={borrowedGear} onReturn={handleGearReturn} onScan={() => addToast('Scan', 'Camera active')} lang={lang} />;
                    case 'life': return <LifeView lang={lang} />;
                    default: return null;
                }
            };

            if (!currentUser) return <LoginView onLogin={setCurrentUser} lang={lang} setLang={setLang} />;

            return (
                <div className="flex h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden">
                    <ToastContainer toasts={toasts} removeToast={(id) => setToasts(p => p.filter(t => t.id !== id))} />
                    
                    {/* Mobile Header */}
                    <div className="md:hidden fixed top-0 left-0 right-0 h-16 bg-white border-b border-slate-200 z-50 flex items-center px-4">
                        {history.length > 1 && (
                            <button onClick={goBack} className="p-2 mr-2 -ml-2 rounded-full hover:bg-slate-100">
                                <i data-lucide="arrow-left" width="20"></i>
                            </button>
                        )}
                        <div className="flex items-center gap-2 font-bold text-slate-800">
                            <div className="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white"><i data-lucide="command" width="16"></i></div>
                            ResQ v8.2
                        </div>
                    </div>

                    {/* Navigation */}
                    <nav className="hidden md:flex w-64 bg-white border-r border-slate-200 flex-col z-20 shadow-xl">
                        <div className="p-5 border-b border-slate-100 flex flex-col items-start gap-1">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white"><i data-lucide="command" width="16"></i></div>
                                <div className="hidden md:block"><h1 className="font-bold text-slate-800">ResQ v8.2</h1></div>
                            </div>
                            <div className="hidden md:block mt-3 w-full">
                                {currentUser.unit && <div className="bg-slate-50 p-2 rounded text-xs font-bold text-slate-600 mb-2 border border-slate-200"><span className="block text-[8px] text-slate-400 uppercase tracking-widest">Unit</span>{currentUser.unit}</div>}
                                {currentUser.id === 'ic' && <div className="bg-red-50 p-2 rounded text-xs font-bold text-red-600 mb-2 border border-red-200"><span className="block text-[8px] text-red-400 uppercase tracking-widest">Commander</span>{commander}</div>}
                                <div className="flex items-center gap-2 mt-2 pl-1">
                                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">{TRANSLATIONS[lang].designerLabel}</span>
                                    <a href="mailto:0922693981ab11@gmail.com?subject=[ResQ系統回饋]" className="text-slate-400 hover:text-blue-600 transition-colors" title="Email Designer"><i data-lucide="mail" width="12"></i></a>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 py-4 px-2 space-y-1 overflow-y-auto">
                            <button onClick={goBack} disabled={history.length <= 1} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-bold text-sm mb-2 ${history.length <= 1 ? 'text-slate-300 cursor-not-allowed opacity-50' : 'text-slate-600 hover:bg-slate-50 border border-slate-100'}`}>
                                <i data-lucide="arrow-left" width="18"></i>
                                <span className="hidden md:inline">{TRANSLATIONS[lang].nav.back}</span>
                            </button>
                            <div className="border-b border-slate-100 mb-2"></div>
                            {['dashboard', 'medical', 'social', 'volunteers', 'logistics', 'resource', 'life'].map(key => (
                                <button key={key} onClick={() => navigateTo(key)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-bold text-sm ${activeTab === key ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <i data-lucide={key === 'dashboard' ? 'layout-dashboard' : key === 'map' ? 'map' : key === 'medical' ? 'activity' : key === 'volunteers' ? 'users' : key === 'logistics' ? 'package' : key === 'social' ? 'message-circle' : key === 'resource' ? 'recycle' : 'coffee'} width="18"></i>
                                    <span className="hidden md:inline">{TRANSLATIONS[lang].nav[key]}</span>
                                </button>
                            ))}
                        </div>
                        <div className="p-4 border-t border-slate-100">
                            <button onClick={handleLogout} className="w-full flex items-center gap-2 text-red-500 text-xs font-bold px-2"><i data-lucide="log-out" width="14"></i> <span className="hidden md:inline">{TRANSLATIONS[lang].nav.logout}</span></button>
                        </div>
                    </nav>

                    {/* Main */}
                    <main className="flex-1 flex flex-col min-w-0 relative mt-16 md:mt-0">
                        <div className="flex-1 overflow-y-auto pb-24">
                            {history.length > 1 && (
                                <div className="px-6 pt-6 pb-0">
                                    <button onClick={goBack} className="flex items-center gap-2 text-slate-500 hover:text-slate-800 transition-colors font-bold text-sm">
                                        <i data-lucide="arrow-left" width="16"></i>
                                        {TRANSLATIONS[lang].nav.back}
                                    </button>
                                </div>
                            )}
                            {renderContent()}
                        </div>
                        <SafetyBar lang={lang} onSOS={() => alert('SOS Sent!')} isSharing={isLocationSharing} toggleSharing={() => { setIsLocationSharing(!isLocationSharing); addToast('GPS', isLocationSharing ? 'Tracking Stopped' : 'Tracking Enabled'); }} isMeshActive={isMeshActive} toggleMesh={() => { setIsMeshActive(!isMeshActive); addToast('Network', !isMeshActive ? 'Switched to Mesh Mode (D2D)' : 'Switched to Internet'); }} />
                    </main>

                    {/* Modal */}
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={modalType === 'volunteer' ? TRANSLATIONS[lang].actions.addVolunteer : modalType === 'triage' ? TRANSLATIONS[lang].headers.triage : modalType === 'transfer' ? TRANSLATIONS[lang].headers.transferCommand : TRANSLATIONS[lang].actions.submitRequest}>
                        {modalType === 'triage' ? (
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                {['red', 'yellow', 'green', 'black'].map(level => (
                                    <button key={level} onClick={() => { setIsModalOpen(false); addToast('Triage', `Patient tagged: ${level.toUpperCase()}`); }} className={`p-4 rounded-xl font-bold text-sm border-2 border-transparent hover:scale-105 transition-transform triage-${level}`}>
                                        {TRANSLATIONS[lang].triage[level]}
                                    </button>
                                ))}
                            </div>
                        ) : modalType === 'transfer' ? (
                            <form key="transfer" onSubmit={handleTransfer} className="space-y-4">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.targetUnit}</label>
                                    <select name="target" className="w-full bg-white border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                        {TRANSFER_TARGETS.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                </div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.reason}</label><input required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 災情升級" /></div>
                                <div className="pt-4 flex justify-end gap-3">
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-500 font-bold text-sm hover:bg-slate-100 rounded-lg transition-colors">{TRANSLATIONS[lang].actions.cancel}</button>
                                    <button type="submit" className="px-6 py-2 bg-red-600 text-white font-bold text-sm rounded-lg shadow-md hover:bg-red-700 transition-colors">{TRANSLATIONS[lang].actions.confirmTransfer}</button>
                                </div>
                            </form>
                        ) : (
                            <form key={modalType} onSubmit={modalType === 'volunteer' ? handleVolunteerAdd : handleLogisticsAdd} className="space-y-4">
                                {modalType === 'volunteer' ? (
                                    <>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.name}</label><input name="name" required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder={TRANSLATIONS[lang].form.placeholderName} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.phone}</label><input name="phone" required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder={TRANSLATIONS[lang].form.placeholderPhone} /></div>
                                        </div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.skill}</label><input name="skill" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder={TRANSLATIONS[lang].form.placeholderSkill} /></div>
                                    </>
                                ) : (
                                    <>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.item}</label><input name="item" required className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder={TRANSLATIONS[lang].form.placeholderItem} /></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.qty}</label><input name="qty" type="number" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.priority}</label><select name="priority" className="w-full bg-white border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500"><option value="Normal">Normal</option><option value="High">High</option><option value="Urgent">Urgent</option></select></div>
                                        </div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">{TRANSLATIONS[lang].form.from}</label><input name="from" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder={TRANSLATIONS[lang].form.placeholderFrom} /></div>
                                    </>
                                )}
                                <div className="pt-4 flex justify-end gap-3">
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-500 font-bold text-sm hover:bg-slate-100 rounded-lg transition-colors">{TRANSLATIONS[lang].actions.cancel}</button>
                                    <button type="submit" className="px-6 py-2 bg-blue-600 text-white font-bold text-sm rounded-lg shadow-md hover:bg-blue-700 transition-colors">{TRANSLATIONS[lang].actions.confirmAdd}</button>
                                </div>
                            </form>
                        )}
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
